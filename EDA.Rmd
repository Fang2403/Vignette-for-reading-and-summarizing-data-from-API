---
title: Analysing Stock Data from API
author: Fang Wu
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo=TRUE, message = FALSE, warning=FALSE)
```

This document is a vignette to show how to retrieve data from an API. To demonstrate, I'll be interacting with the Polygon.io API. I am going to build a few functions to interact with some of the endpoints and explore aome of the data I can retrieve. 

As a note, 

## Required Packages

I used the following packages to interact with API and analyse the data:

* httr: importing files from Web APIs 

* dplyr: manipulating data 

* jsonlite: converting JSON data to R objects

* ggplot2: visualizing the data

* purrr: maping summary to all columns by group

```{r}
library(httr)
library(dplyr)
library(jsonlite)
library(ggplot2)
library(purrr)
library(lubridate)
```


## API Interaction Functions

I define some functions to interact with Polygon.io API and return well-formatted data. 

helper function to determine the type

Ticker Types

```{r}
ticker_types <- GET("https://api.polygon.io/v3/reference/tickers/types?apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2")
types_data <- fromJSON(rawToChar(ticker_types$content))
types_info <- types_data$results %>% as_tibble() %>% rename(type=description )
types_info
```


```{r}
check_type_code <- function(test, class=NULL, locale=NULL){
    mainURL <- "https://api.polygon.io/v3/reference/tickers/types?"
    apikey <- "&apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2"
    if (! is.null(class)) {class <- paste0("asset_class=", class) }
    if (! is.null(locale)) {locale <- paste0("&locale=", locale) }
    ticker_types <- GET(paste0(mainURL, class, locale,  apikey))
    types_data <- fromJSON(rawToChar(ticker_types$content))
    types_info <- types_data$results %>% as_tibble() %>% rename(type=description )
    if (test %in% types_info$code){
        return(test)
    } else if  (tolower(test) %in% tolower(types_info$type)){
        return(types_info$code[tolower(types_info$type)==tolower(test)] )
    } else {print("No such type supported by polygon.io")}
}
#check
#check_type_code(test="common stock")
```

Tickers

```{r}
tickers_supported <- function(type=NULL, market=NULL, active=TRUE){
    mainURL <- "https://api.polygon.io/v3/reference/tickers?"
    apikey <- "&apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2"
    limit <- "limit=1000"
    if (! is.null(type)) {type <- paste0("type=",check_type_code(type),"&")}
    if (! is.null(market)) {market <- paste0("market=",market,"&")}
    active <- paste0("active=",active,"&")
    option <- paste0(type,market,active,limit)
    next_url<- TRUE
    tickers_info <- NULL
    while (! is.null(next_url)) {
        tikers_raw <- GET(paste0(mainURL, option, apikey))
        tickers_data <- fromJSON(rawToChar(tikers_raw$content))
        tickers <- tickers_data$results %>% as_tibble()
        tickers_info <- bind_rows(tickers_info, tickers)
        next_url <- tickers_data$next_url
        option <- next_url
    }
    return(tickers_info)
}
#check all CS tickers
 tickers_supported(type="CS")

```

Grouped Daily (Bars)

Get the daily open, high, low, and close (OHLC) for the entire stocks/equities markets.

```{r}
date_perform <- function(date){
    mainURL <- "https://api.polygon.io/v2/aggs/grouped/locale/us/market/stocks/"
    apikey <- "?adjusted=true&apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2"
    date_raw <- GET(paste0(mainURL, date, apikey))
    date_data <- fromJSON(rawToChar(date_raw$content))
    date_info <- date_data$results %>% as_tibble() %>% rename(ticker=T, adj.close=c,
                      highest=h, lowest=l, ransactions=n, open=o, volume=v,) %>%
                     select(ticker, open, close, highest, lowest, volume)
    return(date_info)
}
#check function
date_perform("2022-06-10")
```

Aggregates (Bars)

Gain information for tickers over a period

Now let’s plot daily prices, using the Adjusted Price column, since it incorporates events like splits and dividends distribution, which can affect the series.

```{r}
raw <- GET("https://api.polygon.io/v2/aggs/ticker/AAPL/range/1/day/2021-06-01/2022-06-01?adjusted=true&sort=asc&limit=1000&apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2")
data <- fromJSON(rawToChar(raw$content))
t <- data$results$t[1]
library(anytime)
as.POSIXct(t, origin = "1970-01-01")
as.POSIXct(t/1000, origin = "1970-01-01")
```

```{r}
stock_data <- function(ticker, multiplier, timespan, from, to){
    mainURL <- "https://api.polygon.io/v2/aggs"
    apikey <- "?limit=1000&apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2"
    range <- paste0("/range/", multiplier,"/", timespan)
    from <- paste0("/", from)
    to <- paste0("/", to)
    stock_info <- NULL
    for (i in ticker){
        ticker <- paste0("/ticker/", i)
        stock_raw <- GET(paste0(mainURL, ticker, range, from, to, apikey))
        stock_data <- fromJSON(rawToChar(stock_raw$content))
        stock <- stock_data$results %>% as_tibble() %>% 
            rename(adj.close=c, highest=h, lowest=l, open=o, volume=v,
                   volume_weighted_average_price=vw) %>% 
            mutate(ticker=i, date=as.Date(as.POSIXct(t/1000, origin = "1970-01-01"))) %>%                              select(ticker, date, adj.close, highest, lowest, open, volume)
        stock_info = bind_rows(stock_info, stock)
    }                   
    return(stock_info)
}

```

Interested in apple, zoom, google and amd

```{r}

stock_data <- stock_data(ticker=c("AAPL","ZM","GOOGL","TSLA", "MSFT"),multiplier="1", timespan="day",                   from="2021-06-01", to="2022-06-01") 
stock_data
```

calculate simple returns

```{r}
Apple_data <- stock_data %>% filter(ticker=="AAPL")
n <- nrow(Apple_data)
returns <- function(x){
    returns <- c(NA, (x[2:n]-x[1:(n-1)])/(x[1:(n-1)]))
    return(returns)
}
Apple_data <- Apple_data %>% mutate(returns=returns(Apple_data$adj.close))
summary(Apple_data[,c(-1, -2)])
```



```{r}
g <- ggplot(Apple_data, aes(x=date, y=adj.close))
g + geom_line(color="darkblue") +
    labs(x="Date", y="Adjusted Close Price", title="Price Series of AAPL") +
    theme(plot.title = element_text(hjust = 0.5)) +
    scale_x_date(date_labels = "%b %y", date_breaks="2 months")
```

In stocks Technical Analysis, a very used technique is the plot of Moving Averages in the prices graphs. A simple moving average is an arithmetic average from the last $q$ days from a $x_t$ series in the $t$ time period. So, the moving average $MA_q^t$ is given by:
 $$MA_t^q=\frac{1}{q}\sum{x_{t-1}}$$
This indicator is interesting because it helps to identify trends and smooths noises from prices. That is, the bigger the days window for the MA calculation, smaller is the MA responsiveness to price variation. The smaller the window, the faster MA adapts itself to changes. Now let’s calculate two moving averages for the stock prices series, one with 10 days window and the other with 30 days:

```{r}
mean10 <- rollmean(Apple_data$adj.close, k=10, fill=list(NA, NULL, NA), align="right")
mean30 <- rollmean(Apple_data$adj.close, k=30, fill=list(NA, NULL, NA), align="right")
Apple_data$mean10 <- mean10
Apple_data$mean30 <- mean30
```

We calculated the two MA using 10 and 30 days of windows, filling the values with NA and using the periods in the left. Afterwards, we can plot both series in the same graphic of prices to identify trends. An existing theory in Technical Analysis is the one that when two MA of short and long term cross each other, there is an indication of buying or selling the stock. When the short term MA cross the long term upwards, there’s a buy a signal. When the opposite happens, there’s a sell signal.

```{r}
g <- ggplot(Apple_data, aes(x=date))
g + geom_line(aes(y=adj.close,color="close")) +
    geom_line(aes(y=mean10,color="mean10")) +
    geom_line(aes(y=mean30,color="mean30")) +
    labs(x="Date", y="Close Price", title="Price Series of AAPL") +
    theme(plot.title = element_text(hjust = 0.5)) +
    scale_x_date(date_labels = "%b %y", date_breaks="2 months")
```

Verifying the plot, it’s possible to notice that there were 14 points in which the series crossed themselves and 1 point where they overlapped. Following the buy signal, we’d have been successful in 4 of 7 times. Following the sell indication, we’d have done right 5 in 7 times. In total, we’d be 9/14, that is 64% of success with a quite simple indicator. Of course this metric shouldn’d be used alone, many other informations should be considerated.

```{r}
g <- ggplot(Apple_data, aes(x=date, y=return))
g + geom_line()
```

```{r}
g <- ggplot(Apple_data, aes(x=return))
g + geom_histogram()
```

Making a brief analysis of the graphic, it’s possible to see that the smallest return of the series happened around may. More specifically, in may 18, one day after the news release with recordings of brazilian president Michel Temer. In the audios, he agreed to give payments in exchange of silence from arrested politicians. This fact strongly impacted the stocks market, specially brazilian and public companies, like Petrobras

```{r}
summary(Apple_data$returns,na.rm = TRUE)
sd(Apple_data$returns,na.rm = TRUE)
```
We separated in an object all of the returns from 2017, using the function subset(). With this, the descriptive statistics still suggest a negative average return. In other hand, the standard deviation is smaller, which indicates smaller risk. Furthermore, this negative return is given by, in majority, by the big fall in the day 18.

```{r}
g <- ggplot(Apple_data, aes(x=return))
g + geom_histogram()
```

```{r}
stock_data %>% group_by(ticker) %>% summarise(avg=mean(adj.close), sd=sd(adj.close), median=median(adj.close))
```


```{r, size=2000%}
g <- ggplot(stock_data, aes(x=date, y=adj.close, color=ticker))
g + geom_line(lwd=1.3) +
    labs(x="Date", title="Adjusted Close Price") 
```
Google’s stocks are much more expensive than the others', and this difference makes Apple’s and Zoom’s stocks appear much less volatile than they truly are (that is, their price appears to not deviate much).

When trading, we are more concerned about the relative change of an asset rather than its absolute price. A “better” solution would be to plot the information we actually want: the stock’s returns.

```{r, size=2000%}
g <- ggplot(stock_data, aes(x=ticker, y=adj.close))
g + geom_boxplot(aes(color=ticker)) 
```

```{r, size=2000%}
g <- ggplot(Apple_data, aes(x=returns, y=volume))
g + geom_point() 
```


```{r}
summary_by_ticker <- stock_info %>% group_by(ticker) %>% summarise(avg=mean(close), sd=sd(close), avg_v=mean(volume))
summary_by_ticker
```
Moving Averages

Let’s now consider how we can find trends in stocks.

A q-day moving average is, for a series x_t and a point in time t, the average of the past q days: that is, if MA^q_t denotes a moving average process, then:
Moving averages smooth a series and helps identify trends.

You will notice that a moving average is much smoother than the actual stock data. Additionally, it’s a stubborn indicator; a stock needs to be above or below the moving average line in order for the line to change direction. Thus, crossing a moving average signals a possible change in trend, and should draw attention.

Traders are usually interested in multiple moving averages, such as the 20-day, 50-day, and 200-day moving averages. It’s easy to examine multiple moving averages at once.