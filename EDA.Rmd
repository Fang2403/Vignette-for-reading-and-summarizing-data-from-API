---
title: Analysing Stock Data from API
author: Fang Wu
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo=TRUE, message = FALSE)
```

This document is a vignette to show how to retrieve data from an API. To demonstrate, I'll be interacting with the Polygon.io API. I am going to build a few functions to interact with some of the endpoints and explore aome of the data I can retrieve. 

As a note, 

## Required Packages

I used the following packages to interact with API and analyse the data:

* httr: importing files from Web APIs 

* dplyr: manipulating data 

* jsonlite: converting JSON data to R objects

* ggplot2: visualizing the data

* purrr: maping summary to all columns by group

```{r}
library(httr)
library(dplyr)
library(jsonlite)
library(ggplot2)
library(purrr)
library(lubridate)
```


## API Interaction Functions

I define some functions to interact with Polygon.io API and return well-formatted data. 

helper function to determine the type

Ticker Types

```{r}
ticker_types <- GET("https://api.polygon.io/v3/reference/tickers/types?apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2")
types_data <- fromJSON(rawToChar(ticker_types$content))
types_info <- types_data$results %>% as_tibble() %>% rename(type=description )
types_info
```


```{r}
check_type_code <- function(test, class=NULL, locale=NULL){
    mainURL <- "https://api.polygon.io/v3/reference/tickers/types?"
    apikey <- "&apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2"
    if (! is.null(class)) {class <- paste0("asset_class=", class) }
    if (! is.null(locale)) {locale <- paste0("&locale=", locale) }
    ticker_types <- GET(paste0(mainURL, class, locale,  apikey))
    types_data <- fromJSON(rawToChar(ticker_types$content))
    types_info <- types_data$results %>% as_tibble() %>% rename(type=description )
    if (test %in% types_info$code){
        return(test)
    } else if  (tolower(test) %in% tolower(types_info$type)){
        return(types_info$code[tolower(types_info$type)==tolower(test)] )
    } else {print("No such type supported by polygon.io")}
}
#check
#check_type_code(test="common stock")
```

Tickers

```{r}
tickers_supported <- function(type=NULL, market=NULL, active=TRUE){
    mainURL <- "https://api.polygon.io/v3/reference/tickers?"
    apikey <- "&apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2"
    limit <- "limit=1000"
    if (! is.null(type)) {type <- paste0("type=",check_type_code(type),"&")}
    if (! is.null(market)) {market <- paste0("market=",market,"&")}
    active <- paste0("active=",active,"&")
    option <- paste0(type,market,active,limit)
    next_url<- TRUE
    tickers_info <- NULL
    while (! is.null(next_url)) {
        tikers_raw <- GET(paste0(mainURL, option, apikey))
        tickers_data <- fromJSON(rawToChar(tikers_raw$content))
        tickers <- tickers_data$results %>% as_tibble()
        tickers_info <- bind_rows(tickers_info, tickers)
        next_url <- tickers_data$next_url
        option <- next_url
    }
    return(tickers_info)
}
#check all CS tickers
 tickers_supported(type="CS")

```

Grouped Daily (Bars)

Get the daily open, high, low, and close (OHLC) for the entire stocks/equities markets.

```{r}
date_perform <- function(date){
    mainURL <- "https://api.polygon.io/v2/aggs/grouped/locale/us/market/stocks/"
    apikey <- "?adjusted=true&apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2"
    date_raw <- GET(paste0(mainURL, date, apikey))
    date_data <- fromJSON(rawToChar(date_raw$content))
    date_info <- date_data$results %>% as_tibble() %>% rename(ticker=T, adj.close=c,
                      highest=h, lowest=l, ransactions=n, open=o, volume=v,) %>%
                     select(ticker, open, close, highest, lowest, volume)
    return(date_info)
}
#check function
date_perform("2022-06-10")
```

Aggregates (Bars)

Gain information for tickers over a period

```{r}
raw <- GET("https://api.polygon.io/v2/aggs/ticker/AAPL/range/1/day/2021-06-01/2022-06-01?adjusted=true&sort=asc&limit=1000&apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2")
data <- fromJSON(rawToChar(raw$content))
t <- data$results$t[1]
library(anytime)
as.POSIXct(t, origin = "1970-01-01")
as.POSIXct(t/1000, origin = "1970-01-01")
```

```{r}
stock_data <- function(ticker, multiplier, timespan, from, to){
    mainURL <- "https://api.polygon.io/v2/aggs"
    apikey <- "?limit=1000&apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2"
    range <- paste0("/range/", multiplier,"/", timespan)
    from <- paste0("/", from)
    to <- paste0("/", to)
    stock_info <- NULL
    for (i in ticker){
        ticker <- paste0("/ticker/", i)
        stock_raw <- GET(paste0(mainURL, ticker, range, from, to, apikey))
        stock_data <- fromJSON(rawToChar(stock_raw$content))
        stock <- stock_data$results %>% as_tibble() %>% 
            rename(adj.close=c, highest=h, lowest=l, open=o, volume=v,
                   volume_weighted_average_price=vw) %>% 
            mutate(ticker=i, date=as.POSIXct(t/1000, origin = "1970-01-01")) %>%                              select(ticker, date, adj.close, highest, lowest, open, volume)
        stock_info = bind_rows(stock_info, stock)
    }                   
    return(stock_info)
}

```

Interested in apple, zoom, google and amd

```{r}

stock_data <- stock_data(ticker=c("AAPL","ZM","GOOGL","TSLA"),multiplier="1", timespan="day",                   from="2021-06-01", to="2022-06-01") 
stock_data
```

calculate simple returns

```{r}
Apple_data <- stock_data %>% filter(ticker=="AAPL")
n <- nrow(Apple_data)
returns <- function(x){
    returns <- c(NA, (x[2:n]-x[1:(n-1)])/(x[1:(n-1)]))
    return(returns)
}
Apple_data <- Apple_data %>% mutate(returns=returns(Apple_data$adj.close))
Apple_data
```

```{r}
g <- ggplot(Apple_data, aes(x=date, y=return))
g + geom_line()
```



```{r}
stock_data %>% group_by(ticker) %>% summarise(avg=mean(adj.close), sd=sd(adj.close), median=median(adj.close))
```


```{r, size=2000%}
g <- ggplot(stock_data, aes(x=date, y=adj.close, color=ticker))
g + geom_line(lwd=1.3) +
    labs(x="Date", title="Adjusted Close Price") 
```

```{r, size=2000%}
g <- ggplot(stock_data, aes(x=ticker, y=adj.close))
g + geom_boxplot(aes(color=ticker)) 
```

```{r, size=2000%}
g <- ggplot(Apple_data, aes(x=returns, y=volume))
g + geom_point() 
```


```{r}
summary_by_ticker <- stock_info %>% group_by(ticker) %>% summarise(avg=mean(close), sd=sd(close), avg_v=mean(volume))
summary_by_ticker
```
 "Dec 2021", "Jan 2022", "Feb 2022", "Mar 2022", "Apr 2022", "May 2022"
 +
    scale_x_discrete(labels=c("Jun 2021", "Aug 2021","Oct 2021","Dec 2021", "Feb 2022", "Apr 2022", ))
    
```{r}
raw <- GET("https://api.polygon.io/v3/trades/AAPL?apiKey=dJT0WQZ7GwH45bAZ8TBZT3KusMgjNJM2")
data <- fromJSON(rawToChar(raw$content))
str(data)
```

